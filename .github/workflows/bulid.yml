# ğŸ“› å·¥ä½œæµåç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢ä¸Š
name: Build and Deploy VitePress

# ğŸš€ å·¥ä½œæµè§¦å‘æ¡ä»¶ï¼šå½“æ¨é€åˆ° main åˆ†æ”¯ã€åˆ›å»º PRï¼Œæˆ–æ‰‹åŠ¨è§¦å‘æ—¶æ‰§è¡Œ
on:
  push:
    branches: [main]           # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [main]           # PR åˆå¹¶åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:           # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

# ğŸŒ è®¾ç½®ç¯å¢ƒå˜é‡ï¼šæ—¶åŒºä¸ºä¸­å›½æ ‡å‡†æ—¶é—´
env:
  TZ: Asia/Shanghai

# ğŸ” æƒé™è®¾ç½®ï¼šå…è®¸è®¿é—® GitHub Pages å’Œèº«ä»½ä»¤ç‰Œ
permissions:
  contents: read               # è¯»å–ä»“åº“å†…å®¹
  pages: write                 # å†™å…¥ GitHub Pages
  id-token: write              # ç”¨äºèº«ä»½éªŒè¯ä»¤ç‰Œï¼ˆOIDCï¼‰

# ğŸš¦ å¹¶å‘æ§åˆ¶ï¼šé˜²æ­¢å¤šä¸ªéƒ¨ç½²åŒæ—¶è¿›è¡Œ
concurrency:
  group: pages                 # åŒä¸€ç»„å‘½åï¼Œé¿å…é‡å¤éƒ¨ç½²
  cancel-in-progress: false   # ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„éƒ¨ç½²

# ğŸ§± å®šä¹‰ä¸¤ä¸ªä»»åŠ¡ï¼šbuild å’Œ deploy
jobs:
  # ğŸ—ï¸ æ„å»ºä»»åŠ¡
  build:
    runs-on: ubuntu-latest     # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒ

    strategy:
      matrix:
        node-version: [20]     # ä½¿ç”¨ Node.js 20 ç‰ˆæœ¬

    steps:
      # ğŸ“¥ ç¬¬ä¸€æ­¥ï¼šæ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0       # ä¿ç•™å®Œæ•´ Git å†å²è®°å½•ï¼ˆç”¨äºéƒ¨ç½²ï¼‰

      # ğŸ§° ç¬¬äºŒæ­¥ï¼šå®‰è£… Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # ğŸ“¦ ç¬¬ä¸‰æ­¥ï¼šå®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆä½¿ç”¨ npmï¼‰
      - name: Install dependencies
        run: npm install

      # ğŸ—ï¸ ç¬¬å››æ­¥ï¼šæ„å»º VitePress é¡¹ç›®ï¼ˆä½¿ç”¨ npx ç¡®ä¿æƒé™å’Œè·¯å¾„æ­£ç¡®ï¼‰
      - name: Build VitePress site
        run: npx vitepress build docs

      # ğŸ“¤ ç¬¬äº”æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©ä¾›éƒ¨ç½²ä½¿ç”¨
      - name: Upload build artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist  # VitePress é»˜è®¤è¾“å‡ºç›®å½•

  # ğŸšš éƒ¨ç½²ä»»åŠ¡
  deploy:
    environment:
      name: github-pages       # GitHub Pages ç¯å¢ƒ
      url: ${{ steps.deployment.outputs.page_url }}  # è‡ªåŠ¨ç”Ÿæˆéƒ¨ç½²åçš„é¡µé¢åœ°å€
    runs-on: ubuntu-latest
    needs: build               # ç­‰å¾… build ä»»åŠ¡å®Œæˆåæ‰§è¡Œ

    steps:
      # ğŸš€ æœ€åä¸€æ­¥ï¼šéƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
